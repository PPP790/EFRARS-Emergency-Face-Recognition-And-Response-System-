<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Evacuation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Light blue-gray background */
            color: #2d3748; /* Dark text */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better layout */
            min-height: 100vh;
        }
        .dashboard-container {
            width: 100%;
            max-width: 1200px;
            margin: 20px;
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .header {
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #edf2f7;
        }
        .header h1 {
            font-size: 2.75rem; /* Larger heading */
            font-weight: 700; /* Bold */
            color: #1a202c;
            margin-bottom: 0.5rem;
        }
        .status-boxes-container {
            display: grid;
            grid-template-columns: 1fr; /* Single column on small screens */
            gap: 1.5rem;
        }
        @media (min-width: 768px) { /* Two columns on medium screens and up */
            .status-boxes-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .status-box {
            background-color: #f7fafc;
            border-radius: 0.75rem; /* Rounded corners */
            padding: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            max-height: 400px; /* Fixed height for scrolling */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .status-box h2 {
            font-size: 1.75rem; /* Larger subheadings */
            font-weight: 600; /* Semi-bold */
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        .safe-header {
            color: #10b981; /* Green */
        }
        .unaccounted-header {
            color: #ef4444; /* Red */
        }
        .status-list li {
            padding: 0.6rem 0;
            border-bottom: 1px dashed #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
        }
        .status-list li:last-child {
            border-bottom: none;
        }
        .safe-item {
            color: #059669; /* Darker green */
        }
        .unaccounted-item {
            color: #dc2626; /* Darker red */
        }
        .empty-list {
            font-style: italic;
            color: #a0aec0; /* Lighter gray */
            text-align: center;
            padding: 1rem;
        }
        .camera-feed-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #000;
            border-radius: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        .camera-feed-container img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            max-width: 640px; /* Match Python stream width */
            margin-bottom: 1rem;
            background-color: #333; /* Dark background for empty video area */
        }
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        .control-panel button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .start-btn {
            background-color: #48bb78; /* Green */
            color: white;
        }
        .start-btn:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .stop-btn {
            background-color: #f56565; /* Red */
            color: white;
        }
        .stop-btn:hover {
            background-color: #e53e3e;
            transform: translateY(-2px);
        }
        .status-indicator {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            margin-top: 1rem;
            text-align: center;
        }
        .status-indicator.active {
            background-color: #38a169; /* Green for active */
        }
        .status-indicator.inactive {
            background-color: #e53e3e; /* Red for inactive */
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1 class="text-gray-800">Emergency Evacuation Dashboard</h1>
            <p id="last-updated" class="text-sm text-gray-500 mt-2">Last Updated: Loading...</p>
        </div>

        <div class="control-panel">
            <button id="mainActionButton" class="start-btn">Start Emergency Monitoring</button>
        </div>
        <div id="systemStatus" class="status-indicator inactive">System Inactive</div>

        <div class="camera-feed-container">
            <h2 class="text-white text-xl font-semibold mb-2">Live Camera Feed</h2>
            <img id="videoFeed" alt="Live Webcam Feed" class="w-full rounded-lg shadow-md border-2 border-gray-700">
        </div>

        <div class="status-boxes-container">
            <div id="unaccounted-section" class="status-box">
                <h2 class="unaccounted-header">UNACCOUNTED FOR (<span id="unaccounted-count">0</span>)</h2>
                <ul id="unaccounted-list" class="status-list">
                    <li class="empty-list">Loading employees...</li>
                </ul>
            </div>

            <div id="safe-section" class="status-box">
                <h2 class="safe-header">SAFE (<span id="safe-count">0</span>)</h2>
                <ul id="safe-list" class="status-list">
                    <li class="empty-list">No one accounted for yet.</li>
                </ul>
            </div>
        </div>

        <div class="footer text-center text-gray-600 text-sm mt-4">
            <p>Powered by Laxman Solutions.ltd</p>
        </div>
    </div>

    <script>
        // --- Get all necessary DOM elements once ---
        const mainActionButton = document.getElementById('mainActionButton');
        const systemStatusIndicator = document.getElementById('systemStatus');
        const lastUpdatedElement = document.getElementById('last-updated');
        const safeCountElement = document.getElementById('safe-count');
        const safeListElement = document.getElementById('safe-list');
        const unaccountedCountElement = document.getElementById('unaccounted-count');
        const unaccountedListElement = document.getElementById('unaccounted-list');
        const videoFeedElement = document.getElementById('videoFeed');

        // --- State variables ---
        let isMonitoringActive = false; // This is our FRONTEND state tracker
        let statusInterval;

        /**
         * Function to update the dashboard UI based on data from the server.
         * This is the main rendering loop.
         */
        function updateDashboardUI(data) {
            lastUpdatedElement.textContent = `Current Time: ${data.timestamp}`;
            
            // --- Update SAFE list ---
            safeCountElement.textContent = data.safe.length;
            safeListElement.innerHTML = '';
            if (data.safe.length === 0) {
                safeListElement.innerHTML = '<li class="empty-list">No one accounted for yet.</li>';
            } else {
                data.safe.forEach(employee => {
                    const li = document.createElement('li');
                    li.className = 'safe-item';
                    li.innerHTML = `<span>${employee.name} (Phone: ${employee.phone})</span><span>Detected at: ${employee.detectedAt}</span>`;
                    safeListElement.appendChild(li);
                });
            }

            // --- Update UNACCOUNTED FOR list ---
            unaccountedCountElement.textContent = data.unaccounted.length;
            unaccountedListElement.innerHTML = '';
            if (data.unaccounted.length === 0) {
                unaccountedListElement.innerHTML = '<li class="empty-list">Everyone is accounted for!</li>';
            } else {
                data.unaccounted.forEach(employee => {
                    const li = document.createElement('li');
                    li.className = 'unaccounted-item';
                    li.textContent = `${employee.name} (Phone: ${employee.phone})`;
                    unaccountedListElement.appendChild(li);
                });
            }

            // --- CRITICAL OPTIMIZATION: MJPEG Stream Handling ---
            // We compare the BACKEND state (data.processing_active) with our FRONTEND state (isMonitoringActive)
            // This ensures we only run the "start" and "stop" stream logic ONCE on state change, not on every poll.
            
            if (data.processing_active) {
                // --- Backend is ACTIVE ---
                mainActionButton.textContent = 'Stop Emergency Monitoring';
                mainActionButton.classList.remove('start-btn');
                mainActionButton.classList.add('stop-btn');
                systemStatusIndicator.textContent = 'System Active';
                systemStatusIndicator.classList.remove('inactive');
                systemStatusIndicator.classList.add('active');
                
                if (!isMonitoringActive) {
                    // Frontend was INACTIVE, but backend is ACTIVE. This is the "START" transition.
                    console.log("State change: Starting video stream.");
                    // Start the stream. Add a cache-buster query param just once on start.
                    videoFeedElement.src = "{{ url_for('video_feed') }}" + "?t=" + new Date().getTime();
                }
                isMonitoringActive = true; // Sync our frontend state

            } else {
                // --- Backend is INACTIVE ---
                mainActionButton.textContent = 'Start Emergency Monitoring';
                mainActionButton.classList.remove('stop-btn');
                mainActionButton.classList.add('start-btn');
                systemStatusIndicator.textContent = 'System Inactive';
                systemStatusIndicator.classList.remove('active');
                systemStatusIndicator.classList.add('inactive');
                
                if (isMonitoringActive) {
                    // Frontend was ACTIVE, but backend is INACTIVE. This is the "STOP" transition.
                    console.log("State change: Stopping video stream.");
                    // Stop the stream by clearing its source. This closes the persistent HTTP connection.
                    videoFeedElement.src = ""; 
                }
                isMonitoringActive = false; // Sync our frontend state
            }
        } // --- End of updateDashboardUI function ---

        /**
         * Function to fetch status updates from the Flask backend.
         */
        async function fetchStatusUpdate() {
            try {
                const response = await fetch('/status_update');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateDashboardUI(data); // Call the render function with new data
            } catch (error) {
                console.error("Error fetching status update:", error);
                // Optionally show an error on the UI
                lastUpdatedElement.textContent = "Error connecting to server. Retrying...";
            }
        }

        /**
         * Event listener for the main action button.
         */
        mainActionButton.addEventListener('click', async () => {
            try {
                mainActionButton.disabled = true; // Disable button to prevent spam clicks
                const response = await fetch('/toggle_emergency', {
                    method: 'POST'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(data.message);
                
                // Immediately fetch status to reflect the change.
                // The data.processing_active in this response will trigger the video stream logic.
                await fetchStatusUpdate(); 
            } catch (error) {
                console.error("Error toggling emergency state:", error);
            } finally {
                mainActionButton.disabled = false; // Re-enable button
            }
        });

        /**
         * Initial page load logic.
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch status immediately on page load
            fetchStatusUpdate(); 
            
            // Start the 1-second polling interval
            statusInterval = setInterval(fetchStatusUpdate, 1000); 

            // Ensure video feed is blank on initial load
            videoFeedElement.src = "";
        });
    </script>
</body>
</html>
